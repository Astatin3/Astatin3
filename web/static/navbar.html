<head>
  <title>ASTATIN3 - <!-- title --> </title>
  <link rel="icon" type="image/x-icon" href="/images/favicon.ico">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="https://unpkg.com/xterm/css/xterm.css"/>
    <script src="https://unpkg.com/xterm/lib/xterm.js"></script>
    <script src="https://unpkg.com/xterm-addon-fit/lib/xterm-addon-fit.js"></script>

  <style>
    @font-face {
        font-family: 'UbuntuMono Nerd Font Mono';
        src: url("/src/UbuntuMonoNerdFont-Regular.ttf") format('truetype');
    }
    * {
        font-family: 'UbuntuMono Nerd Font Mono' !important;
    }
  </style>
</head>
<body id="terminal" style="margin: 0; height: 100%; overflow: hidden; background-color: black"; ">

<script>


function goto_char(x,y){return "\033["+y+";"+x+"H"}

function set_forground(r,g,b){return "\x1b[38;2;"+r+";"+g+";"+b+"m"}
function set_background(r,g,b){return "\x1b[48;2;"+r+";"+g+";"+b+"m"}

function bold_on(){return "\033[1m"}
function bold_off(){return "\033[21m"}

var term = new Terminal()
const fit = new FitAddon.FitAddon()
term.loadAddon(fit)

const name_width = 51
const name_height = 5

const box_t_char = "─"
const box_r_char = "│"
const box_b_char = "─"
const box_l_char = "│"

const box_tl_char = "┌"
const box_tr_char = "┐"
const box_br_char = "┘"
const box_bl_char = "└"

const box_fill_char = " "

const char_width = 7.5
const char_height = 18

function navbar_box(){
    const width = term.cols
    // term.clear()
    term.write("\033[2J") // clear screen

    term.write(goto_char(0,1)+set_forground(0,255,0)+"    ___   ______________  ___________   _______  " + set_forground(255,255,255))
    term.write(goto_char(0,2)+set_forground(0,255,0)+"   /   | / ___/_  __/   |/_  __/  _/ | / /__  /  " + set_forground(255,255,255))
    term.write(goto_char(0,3)+set_forground(0,255,0)+"  / /| | \\__ \\ / / / /| | / /  / //  |/ / /_ <   "+set_forground(255,255,255))
    term.write(goto_char(0,4)+set_forground(0,255,0)+" / ___ |___/ // / / ___ |/ / _/ // /|  /___/ /   " + set_forground(255,255,255))
    term.write(goto_char(0,5)+set_forground(0,255,0)+"/_/  |_/____//_/ /_/  |_/_/ /___/_/ |_//____/    " + set_forground(255,255,255))
}

let windows = []

class window_box {
  constructor(height, width, x, y, text) {
    this.height = height
    this.width = width
    this.x = x
    this.y = y
    this.text = text

    this.mousedown = false
    this.onresize()
  }

  setText(text){
      this.text = text
  }

  onresize(){
    this.windowdata = [
        box_tl_char+box_t_char.repeat(this.width-2)+box_tr_char
    ]
    let current_text_char = 0;
    for(let y = 0; y < this.height; y++){
        let line = box_l_char;
        for(let x = 0; x < this.width-2; x++){
            if(current_text_char < this.text.length){
                current_text_char++
                line += this.text.charAt(current_text_char-1)
            }else{
                line += box_fill_char
            }
        }
        line += box_r_char
        this.windowdata.push(line)
    }
    this.windowdata.push(box_bl_char+box_b_char.repeat(this.width-2)+box_br_char)
  }

  draw(){
    const top    = this.y;
    const bottom = this.y+this.height;
    const left   = this.x;
    const right  = this.x+this.width;

    for(let i = Math.max(top,0); i <= Math.min(bottom+1,term.rows); i++){
        term.write(goto_char(Math.max(left,0),i) + (this.windowdata[i-top].substring(Math.max(-left,0),Math.min(right,term.cols)-left+1)) )
    }
    // console.log(left)
    //   console.log(Math.max(-left,0))
  }

  isinbox(x,y){
    const top    = this.y;
    const bottom = this.y+this.height;
    const left   = this.x;
    const right  = this.x+this.width;

    return left <= x && x <= right &&
           top <= y && y <= bottom
  }

  onmousedown(x,y){
      this.click_pos = [x,y]
      this.mousedown = true;

      const top    = this.y;
      const bottom = this.y+this.height;
      const left   = this.x;
      const right  = this.x+this.width-1;

      if(y === top && x === left){
          this.click_mode = 1
      }else if(y === top && x === right){
          this.click_mode = 2
      }else if(y === bottom && x === right){
          this.click_mode = 3
      }else if(y === bottom && x === left){
          this.click_mode = 4
      }else if(y === top){
          this.click_mode = 5
      }else if(x === right){
        this.click_mode = 6
      }else if(y === bottom){
          this.click_mode = 7
      }else if(x === left){
          this.click_mode = 8
      }else{
          this.click_mode = 0
      }
  }

  onmousemove(x,y){
      // console.log(this.click_mode)
      switch (this.click_mode) {
          case 0: // middle
            this.x += x-this.click_pos[0]
            this.y += y-this.click_pos[1]
            break
          case 1: // Top left
              this.x += x-this.click_pos[0]
              this.y += y-this.click_pos[1]
              this.width = Math.max(2,this.width-x+this.click_pos[0])
              this.height = Math.max(0,this.height-y+this.click_pos[1])
              this.onresize()
              break
          case 2: // Top right
              this.y += y-this.click_pos[1]
              this.width = Math.max(2,this.width+x-this.click_pos[0])
              this.height = Math.max(0,this.height-y+this.click_pos[1])
              this.onresize()
              break
          case 3: // Bottom right
              this.width = Math.max(2,this.width+x-this.click_pos[0])
              this.height = Math.max(0,this.height+y-this.click_pos[1])
              this.onresize()
              break
          case 4: // Bottom left
              this.x += x-this.click_pos[0]
              this.width = Math.max(2,this.width-x+this.click_pos[0])
              this.height = Math.max(0,this.height+y-this.click_pos[1])
              this.onresize()
              break
          case 5: // top
              this.y += y-this.click_pos[1]
              this.height = Math.max(0,this.height-y+this.click_pos[1])
              this.onresize()
              break
          case 6: // right
              this.width = Math.max(2,this.width+x-this.click_pos[0])
              this.onresize()
              break
          case 7: // bottom
              this.height = Math.max(0,this.height+y-this.click_pos[1])
              this.onresize()
              break
          case 8: // left
              this.x += x-this.click_pos[0]
              this.width = Math.max(2,this.width-x+this.click_pos[0])
              this.onresize()
              break
      }

      this.click_pos = [x,y]
      refresh()
  }

  onmouseup(x,y){
      this.mousedown = false;
  }

}


let w1 = new window_box(35, 50, 10, 10, "Some test data!!! 12345678901234567890123456789012345678901234567890")
windows.push(w1)
let w2 = new window_box(35, 50, 20, 20, "Some test data!!! 12345678901234567890123456789012345678901234567890")
windows.push(w2)
let w3 = new window_box(35, 50, 30, 30, "Some test data!!! 12345678901234567890123456789012345678901234567890")
windows.push(w3)

function reload(){
  term.clear()
  fit.fit()
  refresh()
  console.log("reload")
}

function refresh(){
    navbar_box()
    for(let i = 0; i < windows.length; i++)
        windows[i].draw()
}

let mousedown = false;

document.body.addEventListener("mousedown", (e)=>{
    term.select(-1,-1,-1)

    const x = Math.round(e.x/char_width)
    const y = Math.round(e.y/char_height)
    for(let i = windows.length-1; i >= 0; i--)
        if(windows[i].isinbox(x,y)) {
            const w = windows[i]
            w.onmousedown(x, y)
            windows.splice(i, 1)
            windows.push(w)
            refresh()
            break
        }

    mousedown = true;
});

document.body.addEventListener("mousemove", (e)=>{
    if(!mousedown)
        return

    const x = Math.round(e.x/char_width)
    const y = Math.round(e.y/char_height)
    for(let i = windows.length-1; i >= 0; i--)
        if(windows[i].mousedown) {
            windows[i].onmousemove(x, y)
            break
        }


});

document.body.addEventListener("mouseup", (e)=>{
    const x = Math.round(e.x/char_width)
    const y = Math.round(e.y/char_height)
    for(let i = windows.length-1; i >= 0; i--)
        if(windows[i].isinbox(x,y)) {
            windows[i].onmouseup(x, y)
            break
        }


    mousedown = false;
});


window.onresize = ()=>{reload()}
window.document.body.onload = ()=>{reload()}

term.open(document.getElementById('terminal'));


// reload()

// fit.fit()

let now = new Date()
function format_time(Millis){
  const date = new Date(Millis)

  if(date.getDate() != now.getDate()){
    return date.getMonth()+1 + "/" + date.getDate() + "/" + date.getFullYear()
  }else{
    var Hour = ""
    var Minute = ""
    var AmPm = ""

    if(date.getHours() == 0){
      Hour = "12"
      AmPm = "AM"
    }else if(date.getHours() < 12){
      Hour = date.getHours()
      AmPm = "AM"
    }else if(date.getHours() == 12){
      Hour = "12"
      AmPm = "PM"
    }else{
      Hour = date.getHours() - 12
      AmPm = "PM"
    }

    if(date.getMinutes() < 10){
      Minute = "0" + date.getMinutes()
    }else{
      Minute = date.getMinutes()
    }

    return Hour + ":" + Minute + " " + AmPm

  }
}

times = document.body.getElementsByClassName("format-time")
for(let i=0;i<times.length;i++){
    times[i].innerText = format_time(Number(times[i].innerText)*1000)
}

</script>
</body>